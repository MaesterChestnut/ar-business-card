<html>
  <head>
    <script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/MaesterChestnut/AR.js/mergeBranch/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v4.1.2/dist/aframe-extras.min.js"></script>
    <style>
     /* #overlay-wrapper {
        position: absolute;
        top: 0px;
        height: 100%;
        width: 100%;
        background-color: lavenderblush;
        display: none;
      }

      #text-wrapper {
        height: 100%;
        width: 80%;
        background-color: lightblue;
        margin-left: auto;
        margin-right: auto;
        top: 0;
      }*/

      #arjsDebugUIContainer {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id='overlay-wrapper'>
      <div id='text-wrapper'>
        <div id='title-wrapper'>
        </div>
        <div id='instruction-wrapper'>
        </div>
        <div id='interactive-wrapper'>
        </div>
      </div>
    </div>
    <a-scene embedded vr-mode-ui='enabled: false'
      arjs='sourceType: webcam'>
      <a-assets id="critical-assets">
        <!--a-asset-item id="hollow" src="gltfModels/hollow_mask/scene.gltf"></a-asset-item-->
        <!--audio id="appear" src="appear.wav" preload="auto"></audio-->
        <a-asset-item id="chest-asset" src="gltfModels/treasure_chest/scene.gltf"></a-asset-item>
        <a-asset-item id="spell-asset" src="gltfModels/spell/scene.gltf"></a-asset-item>
      </a-assets>
      <!--a-assets timeout="7000" id="inner-assets">
        <a-asset-item id="tentacle-asset" src="gltfModels/tentacle/scene.gltf"></a-asset-item>
        <a-asset-item id="snitch-asset" src="gltfModels/snitch/scene.gltf"></a-asset-item>
        <a-asset-item id="r2-asset" src="gltfModels/r2/scene.gltf"></a-asset-item>
        <a-asset-item id="shenron-asset" src="gltfModels/shenron/scene.gltf"></a-asset-item>
      </a-assets-->

      <!--a-marker-camera preset='custom' type='pattern' url="https://s3.amazonaws.com/aws-website-chestnutmeansbusiness-l2ucx/panther-pattern.patt"></a-marker-camera-->
      <a-marker preset='hiro' registerevents emitevents='true'>
        <a-entity animation-mixer id="spell" rotation="90" scale=".01 .01 1"
          position="0 0 0" gltf-model="#spell-asset">
          <a-animation id='spell-appear' attribute="scale"
              begin="spell-appear" to=".1 .1 1" dur="6000">
          </a-animation>
        </a-entity>
        <a-entity anim-control animation-mixer="clip: static pose" id="chest"
                  position="0 0 0" gltf-model="#chest-asset" scale=".001 .001 .001">
          <a-animation id="chest-appear" attribute="scale"
                  to=".008 .008 .008" dur="4000" begin="chest-appear">
          </a-animation>
        </a-entity>
      </a-marker>
      <a-camera-static/>
    </a-scene>
    <script>
        var assets = document.querySelectorAll('a-assets');
        assets.forEach((asset) => {
            asset.addEventListener('loaded', () => {
              console.log('Assets Loaded: ', asset);
            })
          });
        var scene = document.querySelector('a-scene');
        let params = (new URL(document.location)).searchParams;
        if(params.get('stats') === "true") {
          scene.setAttribute('stats', true);
        }
    </script>
    <script>
    AFRAME.registerComponent('registerevents', {
      init: function() {
        var marker = this.el;
        var spellEntity = document.getElementById('spell');
        var spellAnimation = document.querySelector('#spell-appear');
        var chestAnimation = document.querySelector('#chest-appear');;
        //var chest = document.querySelector('#chest');
        var animStatus = false;
        //var sound = document.querySelector('[sound]');
        // Make the element emit events when found and when lost.
  			marker.setAttribute('emitevents', 'true');
        marker.addEventListener('markerFound', () => {
          if(!animStatus){
            spellAnimation.emit('spell-appear');
          }
  			});

        spellAnimation.addEventListener('animationend', () => {
          animStatus = true;
          chestAnimation.emit("chest-appear");
        });

  			marker.addEventListener('markerLost', function() {
          //if ends mid appearance - scratch sound
  			});
      }
    });
  </script>
  <script>
    var modelMap = {
      'dragon': {
        'gltf-model': 'url("gltfModels/shenron/scene.gltf")',
        'scale': '.1 .1 .1',
        'animation-mixer': true
      },
      'tentacle': {
        'gltf-model': 'url(gltfModels/tentacle/scene.gltf)',
        'scale': '.1 .5 .1',
        'animation-mixer': true
      },
      'gold': {
        'gltf-model': 'url(gltfModels/snitch/scene.gltf)',
        'scale': '.001 .001 .001',
        'animation-mixer': true
      },
      'R2': {
        'gltf-model': 'url(gltfModels/r2/scene.gltf)',
        'scale': '.1 .1 .1',
        'animation-mixer': true
      }
    };
    var modelVoice;
    var chestCommands = {
      'opensasame': () => {
        //summon random model
        chest.setAttribute('animation-mixer', "clip: *; loop: pingpong; repetitions: 1");
        modelVoice = modelMap['tentacle'];
      },
      'dragon arise': () => {
        chest.setAttribute('animation-mixer', "clip: *; loop: pingpong; repetitions: 1");
        modelVoice = modelMap['shrenron'];
      },
      'open (up)': () => {
        chest.setAttribute('animation-mixer', "clip: *; loop: pingpong; repetitions: 1");
        modelVoice = modelMap['goblin'];
      },
      'let the games begin': () => {
        chest.setAttribute('animation-mixer', "clip: *; loop: pingpong; repetitions: 1");
        modelVoice = modelMap['gold'];
      },
      'I\'ve gotta bad feeling about this': () => {
        chest.setAttribute('animation-mixer', "clip: *; loop: pingpong; repetitions: 1");
        modelVoice = modelMap['R2'];
      },
      'show me *tag': (tag) => {
        chest.setAttribute('animation-mixer', "clip: *; loop: pingpong; repetitions: 1");
        console.log('Summoning ', tag);
        modelVoice = modelMap[tag];
      }
    };
    AFRAME.registerComponent('anim-control', {
      init: function() {
        var chestAnimation = document.querySelector('#chest-appear');
        var chest = document.querySelector('#chest');
        var sceneEl = document.querySelector('a-marker');
        //trigger chest opening
        chestAnimation.addEventListener('animationend', () => {
          if (annyang) {
            annyang.addCommands(chestCommands);
            annyang.start();
          } else {
            chest.setAttribute('animation-mixer', "clip: *; loop: pingpong; repetitions: 1");
          }
        });
        chest.addEventListener('animation-loop', (action) => {
          action.detail.action.clampWhenFinished = true;
        });
        chest.addEventListener('animation-finished', () => {
          var el = document.createElement('a-entity');
          //select modelmap; need to handle if chest isn't open
          var model = modelVoice ? modelVoice : modelMap['tentacle'];
          for (var key in model) {
            console.log('Key: ', key, ' prop: ', model[key]);
            el.setAttribute(key, model[key]);
          }
          el.setAttribute('position', {x: 0, y: 1, z: 0});
          sceneEl.append(el);
        });
      }
    });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>
  </body>
</html>

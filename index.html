<html>
  <head>
    <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/nikolaymihaylov/AR.js/dev/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v4.1.2/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    <a-scene embedded arjs='sourceType: webcam'>
      <a-assets>
        <a-asset-item id="hollow" src="gltfModels/hollow_mask/scene.gltf"></a-asset-item>
        <!--audio id="appear" src="appear.wav" preload="auto"></audio-->
        <a-asset-item id="shenron-asset" src="gltfModels/shenron/scene.gltf"></a-asset-item>
        <a-asset-item id="chest-asset" src="gltfModels/treasure_chest/scene.gltf"></a-asset-item>
        <a-asset-item id="spell-asset" src="gltfModels/spell/scene.gltf"></a-asset-item>
        <a-asset-item id="tentacle-asset" src="gltfModels/tentacle/scene.gltf"></a-asset-item>
        <a-asset-item id="snitch-asset" src="gltfModels/snitch/scene.gltf"></a-asset-item>

      </a-assets>

      <!--a-box position="0 0 1" height="1" width="1"></a-box-->
      <!--a-marker-camera preset='custom' type='pattern' url="https://s3.amazonaws.com/aws-website-chestnutmeansbusiness-l2ucx/panther-pattern.patt"></a-marker-camera-->
      <a-marker preset='hiro' registerevents emitevents='true'>
        <!--a-entity geometry id='gman' position="0 0 -1" gltf-model="#gman"
        scale="2 2 2" rotation="-90">
          <a-animation id='appear-anim' attribute="scale"
                     begin="appear" to="5 5 5" dur="6000"></a-animation>
        </a-entity-->
        <!--a-entity animation-mixer id="shenron" rotation="-90" position="0 0 -1" gltf-model="#shenron" scale=".1 .1 .1">
        </a-entity-->
        <a-entity animation-mixer id="spell" rotation="90" scale=".01 .01 1"
          position="0 0 -2" gltf-model="#spell-asset">
          <a-animation id='spell-appear' attribute="scale"
              begin="spell-appear" to=".1 .1 1" dur="6000">
          </a-animation>
        </a-entity>

        <a-entity anim-control animation-mixer="clip: static pose" id="chest" 
                  position="0 0 -2" gltf-model="#chest-asset" scale=".001 .001 .001">
          <a-animation id="chest-appear" attribute="scale"
                  to=".01 .01 .01" dur="4000" begin="chest-appear">
          </a-animation>
        </a-entity>
      </a-marker>

    </a-scene>
    <script>
    AFRAME.registerComponent('registerevents', {
      init: function() {
        var marker = this.el;
        var spellEntity = document.getElementById('spell');
        var spellAnimation = document.querySelector('#spell-appear');
        var chestAnimation = document.querySelector('#chest-appear');
        var animStatus = false;
        //var sound = document.querySelector('[sound]');
        // Make the element emit events when found and when lost.
  			marker.setAttribute('emitevents', 'true');
        marker.addEventListener('markerFound', () => {
          if(!animStatus){
            spellAnimation.emit('spell-appear');
          }
  			});

        spellAnimation.addEventListener('animationend', () => {
          animStatus = true;
          chestAnimation.emit("chest-appear");
        });

  			marker.addEventListener('markerLost', function() {
          //if ends mid appearance - scratch sound
  			});
      }
    });
  </script>
  <script>
    var modelMap = {
      'shenron': {
        'gltf-model': '#shenron-asset',
        'scale': '.1 .1 .1',
        'animation-mixer': true
      },
      'tentacle': {
        'gltf-model': '#tentacle-asset',
        'scale': '.1 .5 .1',
        'animation-mixer': true
      }
    };
    AFRAME.registerComponent('anim-control', {
      init: function() {
        var chestAnimation = document.querySelector('#chest-appear');
        var chest = document.querySelector('#chest');
        var sceneEl = document.querySelector('a-marker');
        //trigger chest opening
        chestAnimation.addEventListener('animationend', () => {
          chest.setAttribute('animation-mixer', "clip: *; loop: pingpong; repetitions: 1");
        });
        chest.addEventListener('animation-loop', (action) => {
          action.detail.action.clampWhenFinished = true;
        });
        chest.addEventListener('animation-finished', () => {
          var el = document.createElement('a-entity');
          //select modelmap
          var model = modelMap['tentacle'];
          for (var key in model) {
            console.log('Key: ', key, ' prop: ', model[key]);
            el.setAttribute(key, model[key]);
          }
          el.setAttribute('position', {x: 0, y: 1, z: -2});
          sceneEl.append(el);
        });
      }
    });
  </script>
  </body>
</html>
